<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Gonnet - Welcome to the profile of </title>
  <link rel="stylesheet" href="/style.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>.card{border-radius:12px;margin-top:20px}.card-header{font-size:1.1rem;font-weight:bold}</style>
</head>
<body>
    <nav class="navbar navbar-expand-lg">
    <div class="container">
      <a class=" gradient-text" href="/">Gonnet</a>
      <div class="text-muted text-align text-">
         <br>
          Scan to Know More. Connect Instantly.
        </div>
      <div class="collapse navbar-collapse">
        <!--<ul class="navbar-nav ms-auto">
          <div class="text-center mt-3">
        <button  class="btn">
          <li class="nav-item"><a class="nav-link" href="#features">Features</a></li>
        </button>
        </div>
            <div class="text-center mt-3">
        <button  class="btn text-white">
          <li class="nav-item"><a class="nav-link" href="/generate">Create QR</a></li>
        </button>
        </div>
        </ul>-->
      </div>
    </div>
  </nav>
  <div class="container">
    <div class="text-center mt-3">
      <h2 id="profileTitle" class="fw-bold hero text-white">Loading Profile...</h2>
    </div>
    <div id="profileData" class="mt-4"><p class="text-center">Loading profile...</p></div>
  </div>

  <br></br>
  <footer class="brand-footer">
    <p>Â© 2025 Gonnet. All Rights Reserved. <span>Powered by Ganga Motors</span></p>
  </footer>

<script>
let currentUniqueId = null;

async function loadProfile() {
  let uniqueId = window.location.pathname.split("/")[2];
  if (uniqueId.includes("?")) uniqueId = uniqueId.split("?")[0];
  currentUniqueId = uniqueId;

  const res = await fetch(`/api/profile/${uniqueId}`);
  const data = await res.json();

  if (data.error) {
    document.getElementById("profileData").innerHTML =
      `<div class="alert hero alert-danger">${data.error}</div>`;
    return;
  }

  document.getElementById("profileTitle").innerText = `Profile of ${data.name || 'User'}`;
  let html = "";

  const vis = data.visibility || {};
  function isVisible(key) {
    return (vis[key] === undefined) ? true : !!vis[key];
  }

  html += `<div class="card shadow"><div class="card-header hero text-white">Personal Details</div><div class="card-body">`;

  html += `<p><b>Name:</b> ${isVisible('name') ? (data.name || '') : '<span class="text-muted">[Hidden]</span>'}</p>`;
  html += `<p><b>Mobile:</b> ${
    isVisible('mobile')
      ? `<a href="tel:${data.mobile}" class="btn btn-sm btn-outline-success me-2"><i class="fas fa-phone"></i> Call</a> ${data.mobile || ''}`
      : '<span class="text-muted">[Hidden]</span>'
  }</p>`;
  html += `<p><b>Car Number:</b> ${isVisible('carNumber') ? (data.carNumber || '') : '<span class="text-muted">[Hidden]</span>'}</p>`;
  html += `<p><b>Email:</b> ${isVisible('email') ? (data.email || '') : '<span class="text-muted">[Hidden]</span>'}</p>`;
  html += `</div></div>`;

  if (data.bio?.trim()) {
    html += `<div class="card shadow mt-3"><div class="card-header hero text-white">About</div><div class="card-body"><p>${data.bio}</p></div></div>`;
  }

html += `<div class="card shadow mt-3">
  <div class="card-header hero text-white">Emergency Contact</div>
  <div class="card-body">`;

/* Name */
html += `<p><b>Name:</b> ${
  data.emergencyName
    ? (isVisible('emergencyName')
        ? data.emergencyName
        : '<span class="text-muted">[Hidden]</span>')
    : '<span class="text-muted">Not provided</span>'
}</p>`;

/* Relation */
html += `<p><b>Relation:</b> ${
  data.emergencyRelation
    ? (isVisible('emergencyRelation')
        ? data.emergencyRelation
        : '<span class="text-muted">[Hidden]</span>')
    : '<span class="text-muted">Not provided</span>'
}</p>`;

/* Number (unchanged logic, already correct) */
html += `<p><b>Number:</b> ${
  data.emergencyNumber
    ? `<a href="tel:${data.emergencyNumber}" class="btn btn-sm btn-outline-danger me-2">
        <i class="fas fa-phone"></i> Call
      </a> ${
        isVisible('emergencyNumber')
          ? data.emergencyNumber
          : '<span class="text-muted">[Hidden]</span>'
      }`
    : '<span class="text-muted">Not provided</span>'
}</p>`;

html += `</div></div>`;

  const s = data.socialLinks || {};
  let socials = "";
  if (s.instagram) socials += `<a href="${s.instagram}" target="_blank" class="me-2"><i class="fab fa-instagram text-white fa-2x"></i></a>`;
  if (s.linkedin) socials += `<a href="${s.linkedin}" target="_blank" class="me-2"><i class="fab fa-linkedin text-white fa-2x"></i></a>`;
  if (s.github) socials += `<a href="${s.github}" target="_blank" class="me-2"><i class="fab fa-github text-white fa-2x"></i></a>`;
  if (s.twitter) socials += `<a href="${s.twitter}" target="_blank" class="me-2"><i class="fab fa-twitter text-white fa-2x"></i></a>`;
  if (s.facebook) socials += `<a href="${s.facebook}" target="_blank" class="me-2"><i class="fab fa-facebook text-white fa-2x"></i></a>`;
  if (s.website) socials += `<a href="${s.website}" target="_blank" class="me-2"><i class="fas fa-globe text-white fa-2x"></i></a>`;
  if (socials) {
    html += `<div class="mt-3 connect text-center"><h5><i class="fas fa-share-alt"></i> Connect</h5><div class="social-icons">${socials}</div></div>`;
  }

html += `
  <div class="d-flex justify-content-center gap-2 flex-wrap mt-4">

    <button class="btn hero text-white" onclick="sendOtp()">
      <i class="fas fa-edit"></i> Update Information
    </button>

    <a href="/profile/${data.uniqueId}/qr"
       target="_blank"
       class="btn hero text-white">
      <i class="fas fa-qrcode"></i> View QR Profile
    </a>

    ${data.mobile ? `
      <a href="https://wa.me/${data.mobile}?text=${encodeURIComponent('Hi, I scanned your Gonnet QR.')}"
         target="_blank"
         class="btn hero text-white">
        <i class="fab fa-whatsapp"></i> Message Owner
      </a>
    ` : ''}

  </div>

  <div id="otpSection" style="display:none;" class="mt-3 text-center">
    <input type="text"
           id="otpInput"
           class="form-control w-50 mx-auto mb-2"
           placeholder="Enter OTP">
    <button class="btn hero text-white" onclick="verifyOtp()">Verify OTP</button>
  </div>
`;

  document.getElementById("profileData").innerHTML = html;
}

async function sendOtp() {
  const res = await fetch(`/api/send-otp/${currentUniqueId}`, { method: "POST" });
  const result = await res.json();
  alert(result.message || "OTP request sent");
  document.getElementById("otpSection").style.display = "block";
}

async function verifyOtp() {
  const otp = document.getElementById("otpInput").value;
  const res = await fetch(`/api/verify-otp/${currentUniqueId}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ otp })
  });
  const result = await res.json();
  if (result.success) {
    window.location.href = result.redirect || `/profile/${currentUniqueId}/input?fromOtp=true`;
  } else {
    alert(result.error || "OTP verification failed");
  }
}

loadProfile();
</script>
</body>
</html>